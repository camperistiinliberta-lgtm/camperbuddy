<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <title>CamperBuddy</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Leaflet (MAPPE) -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
  ></script>

  <!-- Supabase JS client via CDN -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    :root {
      --bg: #050814;
      --bg-soft: #080c20;
      --accent: #39ffdd;
      --accent-alt: #ff6bcb;
      --accent-soft: rgba(57, 255, 221, 0.4);
      --accent-alt-soft: rgba(255, 107, 203, 0.4);
      --text: #f5f5ff;
      --muted: #9aa0c2;
      --danger: #ff4d6a;
    }

    * {
      box-sizing: border-box;
    }

    html, body {
      margin: 0;
      padding: 0;
    }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
        sans-serif;
      background:
        radial-gradient(circle at 10% 0%, rgba(57, 255, 221, 0.12) 0, transparent 40%),
        radial-gradient(circle at 90% 0%, rgba(255, 107, 203, 0.12) 0, transparent 40%),
        radial-gradient(circle at 50% 100%, rgba(57, 255, 221, 0.1) 0, transparent 45%),
        #050814;
      color: var(--text);
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: flex-start;
    }

    .hidden {
      display: none;
    }

    .app {
      max-width: 1200px;
      width: 100%;
      padding: 16px;
      margin: 0 auto;
    }

    header {
      margin-bottom: 24px;
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      gap: 8px;
    }

    .brand-main {
      display: flex;
      flex-wrap: wrap;
      align-items: baseline;
      gap: 10px;
    }

    .brand-title {
      margin: 0;
      font-size: clamp(1.9rem, 3vw, 2.4rem);
      font-weight: 800;
      letter-spacing: 0.12em;
      text-transform: uppercase;
      background: linear-gradient(
        90deg,
        #39ffdd,
        #ff6bcb,
        #6b8bff,
        #39ffdd
      );
      background-size: 200% 100%;
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;
      text-shadow:
        0 0 8px rgba(57, 255, 221, 0.9),
        0 0 18px rgba(255, 107, 203, 0.8),
        0 0 28px rgba(107, 139, 255, 0.8);
      animation: brandGlow 6s linear infinite;
      white-space: nowrap;
    }

    @keyframes brandGlow {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }

    .logo {
      font-size: 1.4rem;
      font-weight: 700;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      text-shadow:
        0 0 7px rgba(57, 255, 221, 0.9),
        0 0 15px rgba(255, 107, 203, 0.8);
    }

    .logo span.icon {
      font-size: 1.3rem;
    }

    .logo span.text-main {
      color: var(--accent);
    }

    .logo span.text-sub {
      color: var(--accent-alt);
      font-weight: 400;
      font-size: 0.9rem;
      text-transform: none;
    }

    header p {
      margin: 2px 0 0;
      color: var(--muted);
      font-size: 0.9rem;
      max-width: 520px;
    }

    main {
      display: grid;
      grid-template-columns: minmax(0, 2fr) minmax(0, 1.3fr);
      gap: 24px;
    }

    @media (max-width: 900px) {
      main {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    .neon-card {
      background: radial-gradient(circle at 0 0, rgba(57, 255, 221, 0.06) 0, transparent 55%),
                  radial-gradient(circle at 100% 0, rgba(255, 107, 203, 0.06) 0, transparent 55%),
                  rgba(8, 12, 32, 0.96);
      border-radius: 18px;
      border: 1px solid rgba(105, 122, 255, 0.35);
      box-shadow:
        0 0 15px rgba(57, 255, 221, 0.5),
        0 0 40px rgba(255, 107, 203, 0.25);
      padding: 18px 18px 16px;
      position: relative;
      overflow: hidden;
    }

    .neon-card::before {
      content: "";
      position: absolute;
      inset: -60%;
      background:
        radial-gradient(circle at 20% 20%, rgba(57, 255, 221, 0.08) 0, transparent 50%),
        radial-gradient(circle at 80% 10%, rgba(255, 107, 203, 0.08) 0, transparent 55%),
        radial-gradient(circle at 10% 90%, rgba(105, 122, 255, 0.08) 0, transparent 55%);
      opacity: 0.7;
      filter: blur(2px);
      z-index: -1;
    }

    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
      margin-bottom: 12px;
    }

    .section-header h2 {
      margin: 0;
      font-size: 1.1rem;
      letter-spacing: 0.05em;
      text-transform: uppercase;
      color: var(--accent);
    }

    .section-subtitle {
      margin: 0 0 10px;
      font-size: 0.9rem;
      color: var(--muted);
    }

    .btn {
      border: none;
      outline: none;
      cursor: pointer;
      font-family: inherit;
      font-size: 0.9rem;
      padding: 8px 16px;
      border-radius: 999px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      transition: all 0.15s ease-out;
      white-space: nowrap;
    }

    .btn-primary {
      background: radial-gradient(circle at 0 0, rgba(255, 255, 255, 0.24) 0, transparent 40%),
                  linear-gradient(90deg, var(--accent) 0%, var(--accent-alt) 100%);
      color: #050814;
      font-weight: 600;
      box-shadow:
        0 0 10px rgba(57, 255, 221, 0.65),
        0 0 25px rgba(255, 107, 203, 0.55);
      border: 1px solid rgba(57, 255, 221, 0.7);
    }

    .btn-primary:hover {
      transform: translateY(-1px) scale(1.02);
      box-shadow:
        0 0 14px rgba(57, 255, 221, 0.85),
        0 0 30px rgba(255, 107, 203, 0.7);
    }

    .btn-secondary {
      background: rgba(16, 24, 64, 0.85);
      color: var(--accent);
      border: 1px solid rgba(57, 255, 221, 0.6);
      box-shadow: 0 0 10px rgba(57, 255, 221, 0.4);
    }

    .btn-secondary:hover {
      background: rgba(22, 32, 84, 0.95);
      transform: translateY(-1px);
    }

    .btn-danger {
      background: rgba(70, 10, 26, 0.95);
      color: #ffdce6;
      border: 1px solid rgba(255, 77, 106, 0.7);
      box-shadow: 0 0 10px rgba(255, 77, 106, 0.6);
    }

    .btn-danger:hover {
      background: rgba(90, 16, 34, 0.98);
      transform: translateY(-1px);
    }

    .btn-small {
      padding: 6px 12px;
      font-size: 0.8rem;
    }

    .posts-list {
      display: flex;
      flex-direction: column;
      gap: 12px;
      max-height: 580px;
      overflow-y: auto;
      padding-right: 6px;
    }

    .posts-list::-webkit-scrollbar {
      width: 6px;
    }
    .posts-list::-webkit-scrollbar-track {
      background: rgba(8, 12, 32, 0.9);
    }
    .posts-list::-webkit-scrollbar-thumb {
      background: linear-gradient(var(--accent), var(--accent-alt));
      border-radius: 999px;
    }

    .post-card {
      padding: 14px 14px 10px;
    }

    .post-header {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      gap: 8px;
      margin-bottom: 6px;
    }

    .post-header h3 {
      margin: 0;
      font-size: 1.0rem;
    }

    .post-date {
      font-size: 0.85rem;
      color: var(--accent-alt);
      font-weight: 600;
    }

    .post-meta {
      margin: 0 0 4px;
      font-size: 0.8rem;
      color: var(--muted);
    }
    .post-meta span {
      color: var(--accent-alt);
      font-weight: 500;
    }

    .post-desc {
      margin: 4px 0 6px;
      font-size: 0.9rem;
      color: var(--text);
    }

    .post-contact {
      margin: 0 0 6px;
      font-size: 0.85rem;
      color: var(--muted);
    }

    .post-contact span {
      color: var(--accent);
      font-weight: 500;
    }

    .post-actions {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin: 4px 0 4px;
    }

    .comments {
      border-top: 1px solid rgba(105, 122, 255, 0.45);
      margin-top: 6px;
      padding-top: 6px;
    }

    .comments h4 {
      margin: 0 0 4px;
      font-size: 0.85rem;
      color: var(--accent);
      text-transform: uppercase;
      letter-spacing: 0.06em;
    }

    .comment-list {
      display: flex;
      flex-direction: column;
      gap: 3px;
      max-height: 130px;
      overflow-y: auto;
      margin-bottom: 4px;
    }

    .no-comments {
      margin: 0;
      font-size: 0.8rem;
      color: var(--muted);
      font-style: italic;
    }

    .comment-item {
      font-size: 0.8rem;
      background: rgba(10, 16, 40, 0.9);
      border-radius: 10px;
      padding: 4px 8px;
      border: 1px solid rgba(57, 255, 221, 0.25);
    }

    .comment-author {
      font-weight: 600;
      color: var(--accent-alt);
      margin-right: 4px;
    }

    .comment-form {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
      margin-top: 4px;
    }

    .comment-form input[type="text"] {
      flex: 1;
      min-width: 0;
      border-radius: 999px;
      border: 1px solid rgba(105, 122, 255, 0.6);
      background: rgba(8, 12, 32, 0.95);
      color: var(--text);
      padding: 6px 10px;
      font-size: 0.8rem;
      outline: none;
    }

    .comment-form input::placeholder {
      color: rgba(154, 160, 194, 0.9);
    }

    .comment-form input:focus {
      border-color: var(--accent);
      box-shadow: 0 0 7px rgba(57, 255, 221, 0.7);
    }

    .comment-form .btn-small {
      flex-shrink: 0;
    }

    .empty-state {
      margin: 6px 0 0;
      font-size: 0.9rem;
      color: var(--muted);
    }

    /* MODALE: ora scrollabile */
    .modal {
      position: fixed;
      inset: 0;
      display: none;
      align-items: flex-start; /* parte dall'alto */
      justify-content: center;
      background:
        radial-gradient(circle at 10% 0%, rgba(57, 255, 221, 0.25) 0, transparent 50%),
        radial-gradient(circle at 90% 0%, rgba(255, 107, 203, 0.25) 0, transparent 50%),
        rgba(0, 0, 0, 0.78);
      backdrop-filter: blur(8px);
      z-index: 9999;
      padding: 16px;
      overflow-y: auto; /* permette lo scroll della modale */
    }

    .modal.open {
      display: flex;
    }

    .modal-content {
      max-width: 580px;
      width: 100%;
      max-height: 90vh;  /* non supera lo schermo */
      overflow-y: auto;  /* scroll interno se serve */
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      margin-bottom: 10px;
    }

    .modal-header h2 {
      margin: 0;
      font-size: 1.05rem;
      color: var(--accent);
      text-transform: uppercase;
      letter-spacing: 0.06em;
    }

    .modal-close {
      border: none;
      background: transparent;
      color: var(--muted);
      font-size: 1.4rem;
      cursor: pointer;
      padding: 0 4px;
      line-height: 1;
      border-radius: 999px;
      transition: all 0.15s ease-out;
    }

    .modal-close:hover {
      color: var(--accent-alt);
      background: rgba(255, 107, 203, 0.12);
    }

    .form {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .field {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .field label {
      font-size: 0.85rem;
      color: var(--text);
    }

    .field-hint {
      font-size: 0.75rem;
      color: var(--muted);
    }

    .field-error {
      min-height: 14px;
      font-size: 0.75rem;
      color: var(--danger);
    }

    .field input,
    .field textarea {
      border-radius: 12px;
      border: 1px solid rgba(105, 122, 255, 0.6);
      background: rgba(8, 12, 32, 0.96);
      color: var(--text);
      padding: 8px 10px;
      font-size: 0.9rem;
      outline: none;
      resize: vertical;
    }

    .field textarea {
      min-height: 60px;
      max-height: 140px;
    }

    .field input::placeholder,
    .field textarea::placeholder {
      color: rgba(154, 160, 194, 0.9);
    }

    .field input:focus,
    .field textarea:focus {
      border-color: var(--accent);
      box-shadow: 0 0 10px rgba(57, 255, 221, 0.8);
    }

    .field-invalid {
      border-color: var(--danger) !important;
      box-shadow: 0 0 8px rgba(255, 77, 106, 0.8) !important;
    }

    .form-actions {
      margin-top: 4px;
      display: flex;
      justify-content: flex-end;
    }

    /* MAPPA modale incontri */
    .map-box {
      border-radius: 12px;
      overflow: hidden;
      border: 1px solid rgba(105, 122, 255, 0.6);
      box-shadow: 0 0 12px rgba(57, 255, 221, 0.4);
      background: #020412;
    }

    #meeting-map {
      width: 100%;
      height: 220px;
    }

    .address-row {
      display: flex;
      gap: 6px;
      align-items: stretch;
    }

    .address-row input {
      flex: 1;
      min-width: 0;
    }

    .address-row .btn-small {
      align-self: stretch;
      padding-inline: 12px;
    }

    .leaflet-container {
      background: #020412;
      z-index: 0 !important;
    }
    .leaflet-pane,
    .leaflet-top,
    .leaflet-bottom {
      z-index: 0 !important;
    }

    /* RADAR */
    .radar-card {
      position: relative;
    }

    .radar-card::after {
      content: "";
      position: absolute;
      inset: -20%;
      background:
        radial-gradient(circle at 30% 30%, rgba(57, 255, 221, 0.05) 0, transparent 45%),
        radial-gradient(circle at 80% 20%, rgba(255, 107, 203, 0.06) 0, transparent 50%),
        radial-gradient(circle at 30% 90%, rgba(105, 122, 255, 0.05) 0, transparent 50%);
      opacity: 0.8;
      z-index: -1;
    }

    .radar-controls {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 6px;
    }

    .radar-controls input {
      flex: 1;
      min-width: 0;
      border-radius: 999px;
      border: 1px solid rgba(105, 122, 255, 0.6);
      background: rgba(8, 12, 32, 0.96);
      color: var(--text);
      padding: 7px 10px;
      font-size: 0.9rem;
      outline: none;
    }

    .radar-controls input::placeholder {
      color: rgba(154, 160, 194, 0.9);
    }

    .radar-controls input:focus {
      border-color: var(--accent);
      box-shadow: 0 0 7px rgba(57, 255, 221, 0.7);
    }

    .radar-status {
      margin: 0 0 6px;
      font-size: 0.85rem;
      color: var(--muted);
    }

    .radar-map-box {
      border-radius: 12px;
      overflow: hidden;
      border: 1px solid rgba(105, 122, 255, 0.6);
      box-shadow: 0 0 12px rgba(57, 255, 221, 0.4);
      background: #020412;
      margin-bottom: 6px;
      min-height: 220px;
    }

    #radar-map {
      width: 100%;
      height: 220px;
    }

    .radar-name-tooltip {
      background: rgba(5, 10, 28, 0.95);
      border-radius: 999px;
      border: 1px solid rgba(57, 255, 221, 0.8);
      color: var(--accent);
      font-size: 0.7rem;
      padding: 2px 6px;
      box-shadow: 0 0 8px rgba(57, 255, 221, 0.9);
    }
    .radar-name-tooltip.leaflet-tooltip-top:before {
      border-top-color: rgba(57, 255, 221, 0.8);
    }

    .radar-window {
      margin-top: 4px;
      border-radius: 14px;
      border: 1px solid rgba(57, 255, 221, 0.45);
      background: rgba(5, 10, 28, 0.96);
      padding: 8px;
      box-shadow: 0 0 14px rgba(57, 255, 221, 0.55);
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .radar-window.disabled {
      opacity: 0.5;
    }

    .radar-messages {
      max-height: 200px;
      overflow-y: auto;
      font-size: 0.8rem;
      display: flex;
      flex-direction: column;
      gap: 4px;
      padding-right: 4px;
    }

    .radar-messages::-webkit-scrollbar {
      width: 5px;
    }
    .radar-messages::-webkit-scrollbar-thumb {
      background: var(--accent);
      border-radius: 999px;
    }

    .radar-message {
      padding: 4px 8px;
      border-radius: 999px;
      align-self: flex-start;
      border: 1px solid rgba(57, 255, 221, 0.5);
      background: radial-gradient(circle at 0 0, rgba(57, 255, 221, 0.3) 0, transparent 50%);
    }

    .radar-message.self {
      align-self: flex-end;
      border-color: rgba(255, 107, 203, 0.7);
      background: radial-gradient(circle at 100% 0, rgba(255, 107, 203, 0.35) 0, transparent 50%);
    }

    .radar-form {
      display: flex;
      gap: 6px;
    }

    .radar-form input[type="text"] {
      flex: 1;
      min-width: 0;
      border-radius: 999px;
      border: 1px solid rgba(105, 122, 255, 0.6);
      background: rgba(8, 12, 32, 0.96);
      color: var(--text);
      padding: 6px 10px;
      font-size: 0.8rem;
      outline: none;
    }

    .radar-form input::placeholder {
      color: rgba(154, 160, 194, 0.9);
    }

    .radar-form input:focus {
      border-color: var(--accent-alt);
      box-shadow: 0 0 7px rgba(255, 107, 203, 0.8);
    }

    .radar-form .btn-small {
      flex-shrink: 0;
    }

    .tiny-label {
      font-size: 0.75rem;
      color: var(--muted);
      margin-top: 2px;
    }

    /* DM (chat privata) */
    .dm-window {
      margin-top: 8px;
      border-radius: 14px;
      border: 1px solid rgba(255, 107, 203, 0.6);
      background: rgba(10, 8, 32, 0.98);
      padding: 8px;
      box-shadow:
        0 0 14px rgba(255, 107, 203, 0.7),
        0 0 28px rgba(57, 255, 221, 0.4);
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .dm-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 6px;
      font-size: 0.9rem;
      color: var(--accent);
    }

    .dm-header span {
      font-weight: 600;
    }

    .dm-close {
      border: none;
      background: transparent;
      color: var(--muted);
      font-size: 1.2rem;
      cursor: pointer;
      padding: 0 4px;
      border-radius: 999px;
      transition: all 0.15s ease-out;
    }

    .dm-close:hover {
      color: var(--accent-alt);
      background: rgba(255, 107, 203, 0.15);
    }

    .dm-messages {
      max-height: 200px;
      overflow-y: auto;
      font-size: 0.8rem;
      display: flex;
      flex-direction: column;
      gap: 4px;
      padding-right: 4px;
    }

    .dm-messages::-webkit-scrollbar {
      width: 5px;
    }

    .dm-messages::-webkit-scrollbar-thumb {
      background: var(--accent-alt);
      border-radius: 999px;
    }

    .dm-message {
      padding: 4px 8px;
      border-radius: 12px;
      align-self: flex-start;
      border: 1px solid rgba(57, 255, 221, 0.4);
      background: radial-gradient(circle at 0 0, rgba(57, 255, 221, 0.25) 0, transparent 55%);
      display: inline-flex;
      flex-wrap: wrap;
      gap: 4px;
      max-width: 100%;
    }

    .dm-message.self {
      align-self: flex-end;
      border-color: rgba(255, 107, 203, 0.8);
      background: radial-gradient(circle at 100% 0, rgba(255, 107, 203, 0.3) 0, transparent 55%);
    }

    .dm-author {
      font-weight: 600;
      color: var(--accent-alt);
    }

    .dm-text {
      color: var(--text);
      word-break: break-word;
    }

    .dm-time {
      font-size: 0.7rem;
      color: var(--muted);
      margin-left: auto;
    }

    .dm-empty {
      font-size: 0.8rem;
      color: var(--muted);
      font-style: italic;
    }

    .dm-form {
      display: flex;
      gap: 6px;
      margin-top: 2px;
    }

    .dm-form input[type="text"] {
      flex: 1;
      min-width: 0;
      border-radius: 999px;
      border: 1px solid rgba(105, 122, 255, 0.6);
      background: rgba(8, 12, 32, 0.96);
      color: var(--text);
      padding: 6px 10px;
      font-size: 0.8rem;
      outline: none;
    }

    .dm-form input::placeholder {
      color: rgba(154, 160, 194, 0.9);
    }

    .dm-form input:focus {
      border-color: var(--accent-alt);
      box-shadow: 0 0 7px rgba(255, 107, 203, 0.8);
    }
  </style>
</head>
<body>
  <div class="app">
    <header>
      <div class="brand-main">
        <h1 class="brand-title">Camperisti in Libert√†</h1>
        <div class="logo">
          <span class="icon">üöê</span>
          <span class="text-main">CamperBuddy</span>
          <span class="text-sub">incontri &amp; radar</span>
        </div>
      </div>
      <p>
        Segna dove sarai nei prossimi 30 giorni, organizza un incontro e fatti trovare
        da altri camperisti. La bacheca e il radar usano Supabase come backend.
      </p>
    </header>

    <main>
      <!-- BACHECA -->
      <section>
        <div class="neon-card">
          <div class="section-header">
            <h2>Bacheca incontri (30 giorni)</h2>
            <button id="open-post-modal" class="btn btn-primary">
              + Crea un incontro
            </button>
          </div>
          <p class="section-subtitle">
            Dalla data di oggi puoi creare incontri entro 1 mese. Il post sparisce dalla bacheca
            1 giorno dopo la data dell'incontro.
          </p>
          <div id="posts" class="posts-list"></div>
        </div>
      </section>

      <!-- RADAR -->
      <section>
        <div class="neon-card radar-card">
          <div class="section-header">
            <h2>Radar</h2>
          </div>
          <p class="section-subtitle">
            Accendi il radar, condividi la tua posizione e scrivi nella chat radar in tempo reale.
            Sarai visibile finch√© non spegni il radar (anche se chiudi la web app).
          </p>

          <div class="radar-controls">
            <input id="radar-name" type="text" maxlength="30" placeholder="Il tuo nome per il radar" />
            <button id="radar-toggle" class="btn btn-secondary">Accendi radar</button>
          </div>
          <p id="radar-status" class="radar-status">Radar spento</p>

          <div class="radar-map-box">
            <div id="radar-map"></div>
          </div>

          <div id="radar-window" class="radar-window disabled">
            <div id="radar-messages" class="radar-messages"></div>
            <form id="radar-form" class="radar-form">
              <input type="text" name="message" maxlength="200" placeholder="Scrivi un messaggio sul radar..." />
              <button type="submit" class="btn btn-primary btn-small">Invia</button>
            </form>
            <p class="tiny-label">
              La chat radar √® condivisa tra tutti quelli con radar attivo.
            </p>
          </div>

          <!-- CHAT PRIVATA (DM) -->
          <div id="dm-window" class="dm-window hidden">
            <div class="dm-header">
              <span id="dm-header-name">Chat</span>
              <button id="dm-close" class="dm-close" aria-label="Chiudi chat">&times;</button>
            </div>
            <div id="dm-messages" class="dm-messages">
              <p class="dm-empty">Seleziona un utente dal radar per iniziare la chat privata.</p>
            </div>
            <form id="dm-form" class="dm-form">
              <input
                id="dm-input"
                type="text"
                maxlength="300"
                placeholder="Messaggio privato..."
              />
              <button type="submit" class="btn btn-primary btn-small">Invia</button>
            </form>
          </div>
        </div>
      </section>
    </main>
  </div>

  <!-- MODALE CREA/MODIFICA INCONTRO -->
  <div id="post-modal" class="modal" aria-hidden="true">
    <div class="modal-content neon-card">
      <div class="modal-header">
        <h2>Crea / modifica incontro</h2>
        <button id="close-post-modal" class="modal-close" aria-label="Chiudi">&times;</button>
      </div>
      <form id="post-form" class="form">
        <div class="field">
          <label for="creator-name">Il tuo nome (verr√† mostrato nella bacheca) *</label>
          <input
            type="text"
            id="creator-name"
            maxlength="60"
            required
            placeholder="Es. Alessandro, Ingrid..."
          />
          <div class="field-hint">
            Comparir√† come autore dell'incontro.
          </div>
          <div class="field-error"></div>
        </div>

        <div class="field">
          <label for="location">Posizione (descrizione luogo) *</label>
          <input
            type="text"
            id="location"
            maxlength="120"
            required
            placeholder="Es. Area sosta XYZ, Citt√†"
          />
          <div class="field-hint">
            Nome del posto o descrizione. Puoi compilarlo tu o lasciarlo riempire dalla ricerca indirizzo.
          </div>
          <div class="field-error"></div>
        </div>

        <div class="field">
          <label>Posizione sulla mappa *</label>
          <div class="map-box">
            <div id="meeting-map"></div>
          </div>
          <div class="field-hint">
            Clicca sulla mappa per scegliere il punto dell'incontro.
          </div>
          <div id="map-error" class="field-error"></div>
        </div>

        <div class="field">
          <label for="address-search">Oppure cerca per indirizzo (opzionale)</label>
          <div class="address-row">
            <input
              type="text"
              id="address-search"
              placeholder="Es. Verona, Via Roma 10"
            />
            <button type="button" id="address-search-btn" class="btn btn-secondary btn-small">
              Cerca sulla mappa
            </button>
          </div>
          <div class="field-hint">
            Inserisci citt√†, via/piazza e numero civico: posizioneremo il segnaposto sulla mappa.
          </div>
          <div class="field-error" id="address-error"></div>
        </div>

        <div class="field">
          <label for="meeting-date">Data dell'incontro (prossimi 30 giorni) *</label>
          <input type="date" id="meeting-date" required />
          <div class="field-error"></div>
        </div>

        <div class="field">
          <label for="contact">Contatto (mail o telefono) *</label>
          <input
            type="text"
            id="contact"
            maxlength="120"
            required
            placeholder="Es. +39..., nome@dominio.com"
          />
          <div class="field-error"></div>
        </div>

        <div class="field">
          <label for="description">Breve descrizione (max 200 caratteri) *</label>
          <textarea
            id="description"
            rows="3"
            maxlength="200"
            required
            placeholder="Es. Sosta di due giorni, chi si unisce?"
          ></textarea>
          <div class="field-error"></div>
        </div>

        <div class="form-actions">
          <button type="submit" class="btn btn-primary">Pubblica incontro</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    (function () {
      const SUPABASE_URL = "https://rxfdutzvncdrudhavtco.supabase.co";
      const SUPABASE_ANON_KEY =
        "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJ4ZmR1dHp2bmNkcnVkaGF2dGNvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUxNTI5MTUsImV4cCI6MjA4MDcyODkxNX0.fdAJXTybv5Kw9ggc_oGsJ8nVMvbpQbJpTiydoFXM0HE";

      const { createClient } = supabase;
      const sb = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

      let currentUserId = null;

      // Stato bacheca
      let postsCache = [];

      // Mappa incontri
      let mapInitialized = false;
      let meetingMap = null;
      let meetingMarker = null;
      let selectedLatLng = null;

      // Mappa radar
      let radarMap = null;
      let radarMapInitialized = false;
      const radarMarkersById = {};
      const radarUsersById = {};

      // Radar stato
      const RADAR_ON_KEY = "camperbuddy_radar_on";
      const RADAR_NAME_KEY = "camperbuddy_radar_name";
      let radarOn = localStorage.getItem(RADAR_ON_KEY) === "1";
      let radarSelfRowId = null;

      // Chat privata (DM)
      let activeDmUserId = null;
      let activeDmDisplayName = null;

      // DOM Bacheca / Modale
      const postsContainer = document.getElementById("posts");
      const postModal = document.getElementById("post-modal");
      const postForm = document.getElementById("post-form");
      const creatorInput = document.getElementById("creator-name");
      const locationInput = document.getElementById("location");
      const contactInput = document.getElementById("contact");
      const descInput = document.getElementById("description");
      const dateInput = document.getElementById("meeting-date");
      const mapErrorEl = document.getElementById("map-error");
      const addressInput = document.getElementById("address-search");
      const addressSearchBtn = document.getElementById("address-search-btn");
      const addressErrorEl = document.getElementById("address-error");
      const openPostBtn = document.getElementById("open-post-modal");
      const closePostBtn = document.getElementById("close-post-modal");

      // DOM Radar (chat generale)
      const radarToggle = document.getElementById("radar-toggle");
      const radarStatus = document.getElementById("radar-status");
      const radarNameInput = document.getElementById("radar-name");
      const radarWindow = document.getElementById("radar-window");
      const radarMessages = document.getElementById("radar-messages");
      const radarForm = document.getElementById("radar-form");

      // DOM DM
      const dmWindow = document.getElementById("dm-window");
      const dmHeaderName = document.getElementById("dm-header-name");
      const dmMessages = document.getElementById("dm-messages");
      const dmForm = document.getElementById("dm-form");
      const dmInput = document.getElementById("dm-input");
      const dmCloseBtn = document.getElementById("dm-close");

      // Date min/max bacheca (oggi -> oggi+30)
      const today = new Date();
      const minDateStr = today.toISOString().split("T")[0];
      const maxDate = new Date(today);
      maxDate.setDate(maxDate.getDate() + 30);
      const maxDateStr = maxDate.toISOString().split("T")[0];
      dateInput.min = minDateStr;
      dateInput.max = maxDateStr;

      // Ripristina nome radar
      const savedRadarName = localStorage.getItem(RADAR_NAME_KEY);
      if (savedRadarName) {
        radarNameInput.value = savedRadarName;
      }

      function escapeHtml(str) {
        return (str || "").replace(/[&<>"']/g, function (c) {
          return {
            "&": "&amp;",
            "<": "&lt;",
            ">": "&gt;",
            '"': "&quot;",
            "'": "&#39;",
          }[c];
        });
      }

      function formatDate(iso) {
        const d = new Date(iso);
        if (isNaN(d.getTime())) return iso || "";
        return d.toLocaleDateString("it-IT", {
          day: "2-digit",
          month: "2-digit",
          year: "numeric",
        });
      }

      function formatTime(iso) {
        const d = new Date(iso);
        if (isNaN(d.getTime())) return "";
        return d.toLocaleTimeString("it-IT", {
          hour: "2-digit",
          minute: "2-digit",
        });
      }

      function cleanupExpiredRows(rows) {
        const now = new Date();
        return rows.filter((row) => {
          if (!row.meeting_date) return true;
          const d = new Date(row.meeting_date);
          if (isNaN(d.getTime())) return true;
          d.setDate(d.getDate() + 1);
          return now <= d;
        });
      }

      function showError(inputEl, msg) {
        const field = inputEl.closest(".field");
        if (!field) return;
        const errEl = field.querySelector(".field-error");
        if (errEl) errEl.textContent = msg || "";
        inputEl.classList.add("field-invalid");
      }

      function clearFormErrors() {
        postForm.querySelectorAll(".field-error").forEach((el) => {
          el.textContent = "";
        });
        postForm.querySelectorAll(".field-invalid").forEach((el) => {
          el.classList.remove("field-invalid");
        });
        mapErrorEl.textContent = "";
        if (addressErrorEl) addressErrorEl.textContent = "";
      }

      function invalidateMaps() {
        if (radarMap) radarMap.invalidateSize();
        if (meetingMap) meetingMap.invalidateSize();
      }

      // Auth anonimo
      async function ensureAuth() {
        try {
          const { data: sessionData } = await sb.auth.getSession();
          if (sessionData && sessionData.session && sessionData.session.user) {
            currentUserId = sessionData.session.user.id;
            return;
          }
          const { data, error } = await sb.auth.signInAnonymously();
          if (error) {
            console.error("Errore signInAnonymously:", error);
            alert("Errore di connessione a Supabase (auth).");
            return;
          }
          if (data && data.user) currentUserId = data.user.id;
        } catch (err) {
          console.error("Errore ensureAuth:", err);
          alert("Errore di connessione a Supabase.");
        }
      }

      // BACHECA
      async function loadPostsFromSupabase() {
        postsContainer.innerHTML =
          '<p class="empty-state">Caricamento bacheca...</p>';

        try {
          const { data, error } = await sb
            .from("encounters")
            .select(
              "id, creator_name, location_text, lat, lng, meeting_date, contact, description, owner_id, created_at, encounter_comments(id, author_name, text, created_at)"
            )
            .order("meeting_date", { ascending: true });

          if (error) {
            console.error("Errore caricando incontri:", error);
            postsContainer.innerHTML =
              '<p class="empty-state">Errore nel caricamento degli incontri.</p>';
            return;
          }

          let rows = data || [];
          rows = cleanupExpiredRows(rows);

          postsCache = rows.map((row) => ({
            id: String(row.id),
            creatorName: row.creator_name,
            location: row.location_text,
            lat: row.lat,
            lng: row.lng,
            meetingDate: row.meeting_date,
            contact: row.contact,
            description: row.description,
            ownerId: row.owner_id,
            comments: (row.encounter_comments || []).sort((a, b) => {
              const da = new Date(a.created_at);
              const db = new Date(b.created_at);
              return da - db;
            }),
          }));

          renderPosts();
        } catch (err) {
          console.error("Errore loadPostsFromSupabase:", err);
          postsContainer.innerHTML =
            '<p class="empty-state">Errore di rete nel caricamento degli incontri.</p>';
        }
      }

      function renderPosts() {
        postsContainer.innerHTML = "";

        if (!postsCache.length) {
          postsContainer.innerHTML =
            '<p class="empty-state">Nessun incontro creato. Clicca su "Crea un incontro" per aggiungerne uno.</p>';
          return;
        }

        postsCache.forEach((post) => {
          const card = document.createElement("article");
          card.className = "post-card neon-card";
          card.dataset.id = post.id;

          const creatorName = post.creatorName || "Anonimo";

          const commentsHtml = (post.comments || [])
            .map(
              (c) =>
                '<div class="comment-item">' +
                '<span class="comment-author">' +
                escapeHtml(c.author_name || "Anonimo") +
                ":</span> " +
                '<span class="comment-text">' +
                escapeHtml(c.text) +
                "</span>" +
                "</div>"
            )
            .join("");

          card.innerHTML =
            '<div class="post-header">' +
            "<h3>" +
            escapeHtml(post.location) +
            "</h3>" +
            '<span class="post-date">' +
            formatDate(post.meetingDate) +
            "</span>" +
            "</div>" +
            '<p class="post-meta">Creato da: <span>' +
            escapeHtml(creatorName) +
            "</span></p>" +
            '<p class="post-desc">' +
            escapeHtml(post.description) +
            "</p>" +
            '<p class="post-contact">Contatto: <span>' +
            escapeHtml(post.contact) +
            "</span></p>" +
            '<div class="post-actions">' +
            (post.ownerId === currentUserId
              ? '<button class="btn btn-secondary btn-small btn-edit">Modifica</button>' +
                '<button class="btn btn-danger btn-small btn-delete">Cancella</button>'
              : "") +
            "</div>" +
            '<div class="comments">' +
            "<h4>Commenti</h4>" +
            '<div class="comment-list">' +
            (commentsHtml ||
              '<p class="no-comments">Ancora nessun commento.</p>') +
            "</div>" +
            '<form class="comment-form">' +
            '<input type="text" name="author" maxlength="30" placeholder="Il tuo nome (opzionale)" />' +
            '<input type="text" name="text" maxlength="100" required placeholder="Scrivi un commento (max 100 caratteri)" />' +
            '<button type="submit" class="btn btn-primary btn-small">Invia</button>' +
            "</form>" +
            "</div>";

          postsContainer.appendChild(card);
        });
      }

      // MAPPA INCONTRI
      function initMeetingMap() {
        if (mapInitialized) return;
        const mapEl = document.getElementById("meeting-map");
        if (!mapEl) return;

        meetingMap = L.map("meeting-map").setView([45.4, 10.99], 6);
        L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
          maxZoom: 19,
          attribution: '&copy; <a href="https://www.openstreetmap.org/">OSM</a>',
        }).addTo(meetingMap);

        meetingMap.on("click", function (e) {
          selectedLatLng = e.latlng;
          if (meetingMarker) {
            meetingMap.removeLayer(meetingMarker);
          }
          meetingMarker = L.marker(selectedLatLng).addTo(meetingMap);
          mapErrorEl.textContent = "";
          reverseGeocode(selectedLatLng.lat, selectedLatLng.lng);
        });

        meetingMap.whenReady(function () {
          meetingMap.invalidateSize();
        });

        mapInitialized = true;
      }

      function setMeetingMapToPost(post) {
        if (!meetingMap) return;
        if (meetingMarker) {
          meetingMap.removeLayer(meetingMarker);
          meetingMarker = null;
        }
        selectedLatLng = null;

        if (post && post.lat != null && post.lng != null) {
          const latlng = { lat: post.lat, lng: post.lng };
          selectedLatLng = latlng;
          meetingMarker = L.marker(latlng).addTo(meetingMap);
          meetingMap.setView(latlng, 10);
        } else {
          meetingMap.setView([45.4, 10.99], 6);
        }
      }

      async function geocodeAndSetMarker() {
        if (!addressInput) return;
        addressErrorEl.textContent = "";
        mapErrorEl.textContent = "";

        const addr = addressInput.value.trim();
        if (!addr) {
          addressErrorEl.textContent = "Inserisci un indirizzo.";
          return;
        }

        try {
          const url =
            "https://nominatim.openstreetmap.org/search?format=json&q=" +
            encodeURIComponent(addr) +
            "&limit=1";
          const resp = await fetch(url, {
            headers: { Accept: "application/json" },
          });
          if (!resp.ok) {
            throw new Error("HTTP " + resp.status);
          }
          const data = await resp.json();
          if (!data || !data.length) {
            addressErrorEl.textContent =
              "Indirizzo non trovato. Prova a essere pi√π preciso.";
            return;
          }
          const best = data[0];
          const lat = parseFloat(best.lat);
          const lng = parseFloat(best.lon);
          if (Number.isNaN(lat) || Number.isNaN(lng)) {
            addressErrorEl.textContent =
              "Risposta non valida dal servizio di mappe.";
            return;
          }

          selectedLatLng = { lat, lng };
          if (meetingMap) {
            if (meetingMarker) {
              meetingMap.removeLayer(meetingMarker);
            }
            meetingMarker = L.marker(selectedLatLng).addTo(meetingMap);
            meetingMap.setView(selectedLatLng, 14);
          }
          mapErrorEl.textContent = "";

          if (!locationInput.value.trim() && best.display_name) {
            locationInput.value = best.display_name.slice(0, 120);
          }
        } catch (err) {
          console.error("Errore geocoding:", err);
          addressErrorEl.textContent =
            "Errore nella ricerca dell'indirizzo. Riprova pi√π tardi.";
        }
      }

      async function reverseGeocode(lat, lng) {
        try {
          const url =
            "https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=" +
            encodeURIComponent(lat) +
            "&lon=" +
            encodeURIComponent(lng);
          const resp = await fetch(url, {
            headers: { Accept: "application/json" },
          });
          if (!resp.ok) return;
          const data = await resp.json();
          if (!data) return;
          const display = data.display_name || "";
          if (display) {
            addressInput.value = display;
            if (!locationInput.value.trim()) {
              locationInput.value = display.slice(0, 120);
            }
          }
        } catch (err) {
          console.warn("Reverse geocoding fallito:", err);
        }
      }

      if (addressSearchBtn) {
        addressSearchBtn.addEventListener("click", function () {
          geocodeAndSetMarker();
        });
      }
      if (addressInput) {
        addressInput.addEventListener("keydown", function (e) {
          if (e.key === "Enter") {
            e.preventDefault();
            geocodeAndSetMarker();
          }
        });
      }

      function openModal(editPost) {
        clearFormErrors();
        postForm.reset();
        delete postForm.dataset.editingId;
        selectedLatLng = null;

        if (editPost) {
          creatorInput.value = editPost.creatorName || "";
          locationInput.value = editPost.location || "";
          contactInput.value = editPost.contact || "";
          descInput.value = editPost.description || "";
          dateInput.value = editPost.meetingDate || "";
          addressInput.value = editPost.location || "";
          postForm.dataset.editingId = editPost.id;
        } else {
          dateInput.value = "";
          addressInput.value = "";
          // Prova a precompilare il nome con quello del radar se c'√®
          const savedName = localStorage.getItem(RADAR_NAME_KEY) || "";
          creatorInput.value = savedName;
        }

        postModal.classList.add("open");
        postModal.setAttribute("aria-hidden", "false");
        document.body.style.overflow = "hidden";

        initMeetingMap();
        setTimeout(function () {
          if (meetingMap) {
            meetingMap.invalidateSize();
            setMeetingMapToPost(editPost || null);
          }
        }, 200);
      }

      function closeModal() {
        postModal.classList.remove("open");
        postModal.setAttribute("aria-hidden", "true");
        document.body.style.overflow = "";
        clearFormErrors();
        delete postForm.dataset.editingId;
        selectedLatLng = null;
      }

      openPostBtn.addEventListener("click", function () {
        openModal(null);
      });

      closePostBtn.addEventListener("click", function () {
        closeModal();
      });

      postModal.addEventListener("click", function (e) {
        if (e.target === postModal) {
          closeModal();
        }
      });

      postForm.addEventListener("submit", async function (e) {
        e.preventDefault();
        clearFormErrors();

        const creatorVal = creatorInput.value.trim();
        const locVal = locationInput.value.trim();
        const contactVal = contactInput.value.trim();
        const descVal = descInput.value.trim();
        const dateVal = dateInput.value;

        let valid = true;

        if (!creatorVal) {
          showError(creatorInput, "Campo obbligatorio");
          valid = false;
        }
        if (!locVal) {
          showError(locationInput, "Campo obbligatorio");
          valid = false;
        }
        if (!contactVal) {
          showError(contactInput, "Campo obbligatorio");
          valid = false;
        }
        if (!dateVal) {
          showError(dateInput, "Campo obbligatorio");
          valid = false;
        } else if (dateVal < minDateStr || dateVal > maxDateStr) {
          showError(dateInput, "La data deve essere entro i prossimi 30 giorni");
          valid = false;
        }
        if (descVal.length > 200) {
          showError(descInput, "Max 200 caratteri");
          valid = false;
        }
        if (!selectedLatLng) {
          mapErrorEl.textContent =
            "Scegli una posizione sulla mappa o usa la ricerca indirizzo.";
          valid = false;
        }

        if (!valid) return;

        const payload = {
          owner_id: currentUserId,
          creator_name: creatorVal,
          location_text: locVal,
          contact: contactVal,
          description: descVal,
          meeting_date: dateVal,
          lat: selectedLatLng ? selectedLatLng.lat : null,
          lng: selectedLatLng ? selectedLatLng.lng : null,
        };

        const editingId = postForm.dataset.editingId;

        try {
          if (editingId) {
            const { error } = await sb
              .from("encounters")
              .update(payload)
              .eq("id", editingId);
            if (error) {
              console.error("Errore update incontro:", error);
              alert("Errore nel salvataggio dell'incontro.");
              return;
            }
          } else {
            const { error } = await sb.from("encounters").insert(payload);
            if (error) {
              console.error("Errore insert incontro:", error);
              alert("Errore nel salvataggio dell'incontro.");
              return;
            }
          }

          closeModal();
          await loadPostsFromSupabase();
        } catch (err) {
          console.error("Errore postForm submit:", err);
          alert("Errore imprevisto nel salvataggio dell'incontro.");
        }
      });

      postsContainer.addEventListener("click", async function (e) {
        const card = e.target.closest(".post-card");
        if (!card) return;
        const id = card.dataset.id;

        if (e.target.classList.contains("btn-delete")) {
          const post = postsCache.find((p) => p.id === id);
          if (!post || post.ownerId !== currentUserId) return;

          if (!confirm("Vuoi davvero cancellare questo incontro?")) return;

          try {
            const { error } = await sb
              .from("encounters")
              .delete()
              .eq("id", id);
            if (error) {
              console.error("Errore cancellazione incontro:", error);
              alert("Errore nella cancellazione dell'incontro.");
              return;
            }
            await loadPostsFromSupabase();
          } catch (err) {
            console.error("Errore delete:", err);
            alert("Errore imprevisto nella cancellazione.");
          }
        } else if (e.target.classList.contains("btn-edit")) {
          const post = postsCache.find((p) => p.id === id);
          if (!post || post.ownerId !== currentUserId) return;
          openModal(post);
        }
      });

      postsContainer.addEventListener("submit", async function (e) {
        if (!e.target.classList.contains("comment-form")) return;
        e.preventDefault();

        const form = e.target;
        const card = form.closest(".post-card");
        if (!card) return;
        const id = card.dataset.id;

        const author = (form.author.value || "").trim();
        const text = (form.text.value || "").trim();

        if (!text) return;
        if (text.length > 100) {
          alert("Commento troppo lungo (max 100 caratteri).");
          return;
        }

        try {
          const { error } = await sb.from("encounter_comments").insert({
            encounter_id: id,
            author_name: author || null,
            text: text,
          });
          if (error) {
            console.error("Errore inserendo commento:", error);
            alert("Errore nell'inserimento del commento.");
            return;
          }

          form.text.value = "";
          await loadPostsFromSupabase();
        } catch (err) {
          console.error("Errore comment form:", err);
          alert("Errore imprevisto nell'inserimento del commento.");
        }
      });

      // RADAR UI
      function setRadarUI(on) {
        radarOn = on;
        if (on) {
          radarToggle.textContent = "Spegni radar";
          radarStatus.textContent = "Radar attivo";
          radarWindow.classList.remove("disabled");
        } else {
          radarToggle.textContent = "Accendi radar";
          radarStatus.textContent = "Radar spento";
          radarWindow.classList.add("disabled");
        }
        localStorage.setItem(RADAR_ON_KEY, on ? "1" : "0");
      }

      setRadarUI(radarOn);

      // RADAR: inizializza mappa, con retry aggressivo (mobile)
      function initRadarMap(force) {
        if (radarMapInitialized && !force) return;
        const mapEl = document.getElementById("radar-map");
        if (!mapEl) return;

        let tentativi = 0;
        const maxTentativi = 30; // 30 * 200ms = 6 secondi

        function createMapWhenReady() {
          if (radarMapInitialized && !force) return;

          const w = mapEl.clientWidth;
          const h = mapEl.clientHeight;

          if ((w === 0 || h === 0) && tentativi < maxTentativi) {
            tentativi++;
            setTimeout(createMapWhenReady, 200);
            return;
          }

          if (w === 0 || h === 0) {
            console.warn("Radar map: il contenitore sembra non avere dimensioni.");
            mapEl.innerHTML =
              '<div style="color:#39ffdd;font-size:0.8rem;padding:8px;text-align:center;">' +
              'Impossibile inizializzare la mappa del radar qui.<br>' +
              "Prova ad aprire la web app direttamente nel browser " +
              "(non nell'anteprima di Google Drive)." +
              "</div>";
            return;
          }

          if (radarMap && force) {
            radarMap.remove();
            radarMap = null;
            radarMapInitialized = false;
          }

          radarMap = L.map("radar-map").setView([45.4, 10.99], 5);
          L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
            maxZoom: 19,
            attribution: '&copy; <a href="https://www.openstreetmap.org/">OSM</a>',
          }).addTo(radarMap);

          radarMap.whenReady(function () {
            radarMap.invalidateSize();
          });

          setTimeout(function () {
            radarMap.invalidateSize();
          }, 600);

          radarMapInitialized = true;
        }

        createMapWhenReady();
      }

      function clearRadarMarkers() {
        if (!radarMap) return;
        Object.values(radarMarkersById).forEach((marker) => {
          radarMap.removeLayer(marker);
        });
        for (const k in radarMarkersById) delete radarMarkersById[k];
      }

      // DM (chat privata)
      async function openDmChat(otherUserId, displayName) {
        if (!otherUserId || otherUserId === currentUserId) return;
        activeDmUserId = otherUserId;
        activeDmDisplayName = displayName || "Camperista";

        dmHeaderName.textContent = "Chat con " + activeDmDisplayName;
        dmWindow.classList.remove("hidden");
        dmMessages.innerHTML =
          '<p class="dm-empty">Caricamento conversazione...</p>';

        await loadDmHistory(otherUserId);
        dmInput.focus();
      }

      function appendDmMessage(row) {
        const isSelf = row.sender_id === currentUserId;
        const div = document.createElement("div");
        div.className = "dm-message" + (isSelf ? " self" : "");
        const name = isSelf ? "Tu" : (row.sender_name || activeDmDisplayName || "Altro");
        const time = formatTime(row.created_at);

        div.innerHTML =
          '<span class="dm-author">' +
          escapeHtml(name) +
          ":</span> " +
          '<span class="dm-text">' +
          escapeHtml(row.text || "") +
          "</span>" +
          (time
            ? '<span class="dm-time">' + escapeHtml(time) + "</span>"
            : "");

        dmMessages.appendChild(div);
        dmMessages.scrollTop = dmMessages.scrollHeight;
      }

      async function loadDmHistory(otherUserId) {
        if (!currentUserId) return;
        try {
          const orFilter =
            `and(sender_id.eq.${currentUserId},receiver_id.eq.${otherUserId}),` +
            `and(sender_id.eq.${otherUserId},receiver_id.eq.${currentUserId})`;

          const { data, error } = await sb
            .from("radar_dm_messages")
            .select("*")
            .or(orFilter)
            .order("created_at", { ascending: true })
            .limit(200);

          dmMessages.innerHTML = "";

          if (error) {
            console.error("Errore caricando DM:", error);
            dmMessages.innerHTML =
              '<p class="dm-empty">Errore nel caricamento della chat.</p>';
            return;
          }

          if (!data || !data.length) {
            dmMessages.innerHTML =
              '<p class="dm-empty">Nessun messaggio. Inizia tu la conversazione!</p>';
            return;
          }

          data.forEach((row) => appendDmMessage(row));
        } catch (err) {
          console.error("Errore loadDmHistory:", err);
          dmMessages.innerHTML =
            '<p class="dm-empty">Errore di rete nel caricamento della chat.</p>';
        }
      }

      dmCloseBtn.addEventListener("click", function () {
        dmWindow.classList.add("hidden");
        activeDmUserId = null;
        activeDmDisplayName = null;
      });

      // DM submit
      dmForm.addEventListener("submit", async function (e) {
        e.preventDefault();
        const text = (dmInput.value || "").trim();
        if (!text) return;

        if (!activeDmUserId) {
          alert("Seleziona prima un utente dal radar cliccando sul suo marker.");
          return;
        }
        if (!radarOn) {
          alert("Per usare la chat privata devi avere il radar attivo.");
          return;
        }

        const senderName = (radarNameInput.value || "").trim() || "Tu";

        try {
          const { error } = await sb.from("radar_dm_messages").insert({
            sender_id: currentUserId,
            receiver_id: activeDmUserId,
            sender_name: senderName,
            text,
          });
          if (error) {
            console.error("Errore inserendo DM:", error);
            alert("Errore nell'invio del messaggio privato.");
            return;
          }

          dmInput.value = "";
          const fakeRow = {
            sender_id: currentUserId,
            sender_name: senderName,
            text,
            created_at: new Date().toISOString(),
          };
          appendDmMessage(fakeRow);
        } catch (err) {
          console.error("Errore DM submit:", err);
          alert("Errore imprevisto nell'invio del messaggio privato.");
        }
      });

      function renderRadarUsers() {
        if (!radarMap) return;
        clearRadarMarkers();
        const users = Object.values(radarUsersById).filter((u) => u.active);

        users.forEach((u) => {
          if (u.lat == null || u.lng == null) return;
          const marker = L.marker([u.lat, u.lng]).addTo(radarMap);
          const rawName = u.display_name || "Camperista";
          const name = escapeHtml(rawName);

          marker.bindTooltip(name, {
            permanent: true,
            direction: "top",
            offset: [0, -10],
            className: "radar-name-tooltip",
          });

          marker.bindPopup(
            "<strong>" + name + "</strong><br><em>Clicca per chattare</em>"
          );

          marker.on("click", function () {
            if (u.user_id) {
              openDmChat(u.user_id, rawName);
            }
          });

          radarMarkersById[u.id] = marker;
        });

        if (users.length) {
          const u0 = users[0];
          if (u0.lat != null && u0.lng != null) {
            radarMap.setView([u0.lat, u0.lng], 6);
          }
        }
      }

      async function loadRadarInitial() {
        try {
          const { data: users, error: usersErr } = await sb
            .from("radar_users")
            .select("*")
            .eq("active", true);

          if (!usersErr && users) {
            users.forEach((u) => {
              radarUsersById[u.id] = u;
              if (u.user_id === currentUserId) radarSelfRowId = u.id;
            });
          }

          initRadarMap();
          if (radarMap) radarMap.invalidateSize();
          renderRadarUsers();

          const { data: msgs, error: msgsErr } = await sb
            .from("radar_messages")
            .select("*")
            .order("created_at", { ascending: true })
            .limit(100);

          radarMessages.innerHTML = "";
          if (!msgsErr && msgs) {
            msgs.forEach((m) =>
              addRadarMessage(m, m.sender_id === currentUserId)
            );
          }
        } catch (err) {
          console.error("Errore loadRadarInitial:", err);
        }
      }

      function addRadarMessage(msgRow, isSelf) {
        const div = document.createElement("div");
        div.className = "radar-message" + (isSelf ? " self" : "");
        const name = msgRow.sender_name || "Anonimo";
        div.textContent = name + ": " + msgRow.text;
        radarMessages.appendChild(div);
        radarMessages.scrollTop = radarMessages.scrollHeight;
      }

      function subscribeRadarRealtime() {
        sb
          .channel("camperbuddy-radar-channel")
          .on(
            "postgres_changes",
            { event: "*", schema: "public", table: "radar_users" },
            (payload) => {
              const row = payload.new || payload.old;
              if (!row) return;
              if (payload.eventType === "INSERT" || payload.eventType === "UPDATE") {
                radarUsersById[row.id] = row;
              } else if (payload.eventType === "DELETE") {
                delete radarUsersById[row.id];
              }
              renderRadarUsers();
              if (row.user_id === currentUserId && payload.new) {
                radarSelfRowId = payload.new.id;
              }
            }
          )
          .on(
            "postgres_changes",
            { event: "INSERT", schema: "public", table: "radar_messages" },
            (payload) => {
              const row = payload.new;
              if (!row) return;
              addRadarMessage(row, row.sender_id === currentUserId);
            }
          )
          .on(
            "postgres_changes",
            { event: "INSERT", schema: "public", table: "radar_dm_messages" },
            (payload) => {
              const row = payload.new;
              if (!row) return;
              if (
                row.sender_id !== currentUserId &&
                row.receiver_id !== currentUserId
              ) {
                return;
              }
              const otherId =
                row.sender_id === currentUserId
                  ? row.receiver_id
                  : row.sender_id;

              if (activeDmUserId && activeDmUserId === otherId) {
                appendDmMessage(row);
              } else {
                // in futuro: si pu√≤ aggiungere una notifica visiva
              }
            }
          )
          .subscribe();
      }

      // BACHECA REALTIME
      function subscribeBachecaRealtime() {
        sb
          .channel("camperbuddy-bacheca-channel")
          .on(
            "postgres_changes",
            { event: "*", schema: "public", table: "encounters" },
            async () => {
              await loadPostsFromSupabase();
            }
          )
          .on(
            "postgres_changes",
            { event: "*", schema: "public", table: "encounter_comments" },
            async () => {
              await loadPostsFromSupabase();
            }
          )
          .subscribe();
      }

      // RADAR: accendi/spegni
      radarToggle.addEventListener("click", async function () {
        if (!radarOn) {
          const name = radarNameInput.value.trim();
          if (!name) {
            alert("Per attivare il radar inserisci il tuo nome.");
            return;
          }
          localStorage.setItem(RADAR_NAME_KEY, name);

          let lat = null,
            lng = null;
          try {
            if ("geolocation" in navigator) {
              await new Promise((resolve) => {
                navigator.geolocation.getCurrentPosition(
                  (pos) => {
                    lat = pos.coords.latitude;
                    lng = pos.coords.longitude;
                    resolve();
                  },
                  () => resolve(),
                  { enableHighAccuracy: true, timeout: 5000 }
                );
              });
            }
          } catch (err) {
            console.warn("Geoloc fallita:", err);
          }

          try {
            const { data, error } = await sb
              .from("radar_users")
              .upsert(
                {
                  user_id: currentUserId,
                  display_name: name,
                  lat,
                  lng,
                  active: true,
                  last_seen: new Date().toISOString(),
                },
                { onConflict: "user_id" }
              )
              .select()
              .maybeSingle();

            if (error) {
              console.error("Errore upsert radar_users:", error);
              alert(
                "Errore nell'attivazione del radar: " +
                  (error.message || "")
              );
              return;
            }
            if (data) {
              radarUsersById[data.id] = data;
              radarSelfRowId = data.id;
              renderRadarUsers();
            }
            setRadarUI(true);
            invalidateMaps();
          } catch (err) {
            console.error("Errore attiva radar:", err);
            alert("Errore imprevisto nell'attivazione del radar.");
          }
        } else {
          try {
            const { error } = await sb
              .from("radar_users")
              .update({ active: false, last_seen: new Date().toISOString() })
              .eq("user_id", currentUserId);
            if (error) {
              console.error("Errore spegnendo radar:", error);
              alert("Errore nello spegnimento del radar.");
              return;
            }
            setRadarUI(false);
          } catch (err) {
            console.error("Errore spegnimento radar:", err);
            alert("Errore imprevisto nello spegnimento del radar.");
          }
        }
      });

      radarNameInput.addEventListener("input", async function () {
        const name = radarNameInput.value.trim();
        localStorage.setItem(RADAR_NAME_KEY, name);
        if (!radarOn) return;
        try {
          const { error } = await sb
            .from("radar_users")
            .update({ display_name: name, last_seen: new Date().toISOString() })
            .eq("user_id", currentUserId);
          if (error) console.error("Errore update nome radar:", error);
        } catch (err) {
          console.error("Errore update nome radar:", err);
        }
      });

      radarForm.addEventListener("submit", async function (e) {
        e.preventDefault();
        const input = radarForm.message;
        const msg = (input.value || "").trim();
        if (!msg) return;
        if (!radarOn) {
          alert("Per inviare messaggi devi avere il radar attivo.");
          return;
        }
        const name = (radarNameInput.value || "").trim() || "Tu";

        try {
          const { error } = await sb.from("radar_messages").insert({
            sender_id: currentUserId,
            sender_name: name,
            text: msg,
          });
          if (error) {
            console.error("Errore inserendo radar_message:", error);
            alert("Errore nell'invio del messaggio radar.");
            return;
          }
          input.value = "";
        } catch (err) {
          console.error("Errore invio messaggio radar:", err);
          alert("Errore imprevisto nell'invio del messaggio radar.");
        }
      });

      // INIT
      (async function init() {
        await ensureAuth();
        if (!currentUserId) return;

        await loadPostsFromSupabase();
        initRadarMap();
        await loadRadarInitial();

        subscribeRadarRealtime();
        subscribeBachecaRealtime();

        invalidateMaps();
      })();

      window.addEventListener("load", function () {
        invalidateMaps();
      });

      window.addEventListener("resize", function () {
        invalidateMaps();
      });

      window.addEventListener("orientationchange", function () {
        setTimeout(invalidateMaps, 300);
      });

      document.addEventListener("visibilitychange", function () {
        if (!document.hidden) {
          invalidateMaps();
        }
      });
    })();
  </script>
</body>
</html>
