<!doctype html>
<html lang="it">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>CamperBuddy</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js"></script>

<style>
html,body{margin:0;padding:0;height:100%;overflow:hidden;font-family:system-ui;background:#05070d;color:#eaf2ff}

/* TORNIAMO FIXED per bypassare i contenitori WordPress (colonna bianca, padding tema ecc.) */
#app{position:fixed;inset:0;display:grid;grid-template-columns:50% 50%}
body.admin-bar #app{top:32px}

#map{width:100%;height:100%;background:#0b1020}

#chatWrap{
  display:grid;
  grid-template-rows:auto 1fr;
  height:100%;
  background:#000;
  min-height:0;
  overflow:hidden;
  -webkit-overflow-scrolling:touch;
}

#authBox{padding:14px;background:#05070d;border-bottom:1px solid #222}
#title{text-align:center;font-size:22px;font-weight:900;color:#00e5ff;text-shadow:0 0 10px #00e5ff,0 0 20px #ff2bd6;margin-bottom:8px}

input,textarea{width:100%;padding:8px;border-radius:8px;border:1px solid #333;background:#05070d;color:#fff;box-sizing:border-box}
textarea{resize:none}
button{padding:8px 12px;border-radius:20px;border:none;font-weight:800;cursor:pointer}
.btnMain{background:linear-gradient(135deg,#00e5ff,#ff2bd6);color:#000}
.btnAlt{background:#141b33;color:#fff}
#radarBtn{margin-top:6px;background:#1b233f;color:#fff}

/* üîî bottone notifiche */
#notifBtn{background:#1b233f;color:#fff}

/* üîÑ bottone refresh */
#refreshBtn{background:#1b233f;color:#fff}

/* chatBody scrollabile per arrivare alla chat sotto */
#chatBody{
  display:grid;
  grid-template-rows:240px auto;
  height:100%;
  background:#000;
  min-height:0;
  overflow-y:auto;
  overflow-x:hidden;
  -webkit-overflow-scrolling:touch;
}

#chatList{
  background:#000;
  border-bottom:1px solid #222;
  overflow-y:auto;
  min-height:0;
  -webkit-overflow-scrolling:touch;
}

.chatItem{display:flex;gap:10px;padding:10px;border-bottom:1px solid #1e1e1e;cursor:pointer}
.chatItem.active{background:#0f1324}
.chatText{flex:1;min-width:0}
.chatName{font-weight:800}
.chatLast{font-size:12px;color:#aaa;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}

.chatDel{
  width:30px;height:30px;border-radius:10px;border:1px solid #ff3b3b;
  background:#2a0f12;color:#ff3b3b;display:grid;place-items:center;cursor:pointer;flex:0 0 auto
}
.chatDel:hover{background:#ff3b3b;color:#000;box-shadow:0 0 12px rgba(255,59,59,.6)}

#chat{
  display:flex;
  flex-direction:column;
  min-width:0;
  background:#000;
  border-top:1px solid #111;
  height:420px;
}

#chatHeader{padding:12px;background:#000;border-bottom:1px solid #222;font-weight:800}

#messages{
  flex:1;
  min-height:0;
  overflow-y:auto;
  padding:12px;
  background:#000;
  -webkit-overflow-scrolling:touch;
}

.msg{max-width:70%;padding:10px;border-radius:12px;margin:6px 0;word-wrap:break-word}
.me{margin-left:auto;background:#00e5ff;color:#000}
.them{background:#1b233f}

/* composer */
#composer{display:flex;flex-direction:column;gap:8px;padding:10px;border-top:1px solid #222;background:#000}
#composerRow{display:flex;gap:8px}
#composerRow input{flex:1}
#composerRow button{background:linear-gradient(135deg,#00e5ff,#ff2bd6)}

/* ‚úÖ Bottone Rendez-vous: IN ALTO SOPRA LA MAPPA */
#rvToggle{
  position:fixed;
  top:12px;
  left:50%;
  transform:translateX(-50%);
  z-index:9500;
  padding:12px 18px;
  border-radius:26px;
  font-size:16px;
  background:linear-gradient(135deg,#00e5ff,#ff2bd6);
  font-weight:900;border:none;
  box-shadow:0 0 18px rgba(0,0,0,.35);
}
body.admin-bar #rvToggle{top:44px;} /* per non finire sotto la barra admin */

/* Panel */
#rvPanel{
  position:fixed;left:0;right:0;bottom:-110%;
  height:64%;
  background:#05070d;border-top:2px solid #ff2bd6;
  z-index:9001;transition:bottom .35s ease;display:flex;flex-direction:column
}
#rvPanel.open{bottom:0}

/* Header con Chiudi non sovrapposto */
#rvHeader{
  padding:12px 96px 12px 16px;
  display:flex;align-items:center;justify-content:center;gap:10px;
  font-weight:900;color:#00e5ff;border-bottom:1px solid #222;
  position:relative;min-height:52px;
}
#rvClose{
  position:absolute;right:10px;top:50%;transform:translateY(-50%);
  background:#141b33;color:#fff;border-radius:14px;padding:6px 12px;font-weight:900
}

#rvForm{padding:12px;display:grid;gap:8px}
#rvFormRow{display:grid;grid-template-columns:1fr 1fr;gap:8px}
#rvPickBtn{background:#1b233f;color:#fff}
#rvHint{font-size:12px;color:#aaa;margin-top:-2px}

#rvDateRow{display:grid;grid-template-columns:1fr 1fr;gap:8px}

#rvActions{display:flex;gap:8px}
#rvPublishBtn{flex:1}
#rvCancelEditBtn{display:none;background:#141b33;color:#fff}

#rvList{flex:1;overflow-y:auto;padding:12px;border-top:1px solid #222}

.rvItem{border:1px solid #222;border-radius:10px;padding:10px;margin-bottom:10px}
.rvTop{display:flex;justify-content:space-between;gap:10px;align-items:flex-start}
.rvUser{font-weight:800}
.rvMeta{font-size:12px;color:#aaa;margin-top:2px}
.rvText{margin:8px 0;font-size:14px}
.rvBtns{display:flex;gap:8px}
.rvBtnDel{background:#2a0f12;color:#ff3b3b;border:1px solid #ff3b3b}
.rvBtnEdit{background:#141b33;color:#fff;border:1px solid #333}

@media (max-width: 980px){
  #app{grid-template-columns:1fr;grid-template-rows:45% 55%}
  #chatBody{grid-template-rows:220px auto;}
  #chat{height:55vh;}
  #rvPanel{height:70%}
}
</style>
</head>

<body>

<div id="app">
  <div id="map"></div>

  <div id="chatWrap">
    <div id="authBox">
      <div id="title">CamperBuddy</div>

      <div id="authForm">
        <!-- ‚úÖ Nick: prima volta s√¨, poi mostra solo riepilogo -->
        <div id="nickRow">
          <input id="nickname" placeholder="Nick name (quello che vedranno gli utenti)">
        </div>

        <div id="nickDisplayRow" style="display:none;align-items:center;gap:10px;margin-bottom:8px">
          <div style="flex:1;color:#cfe6ff">
            Nick: <b id="nickDisplay" style="color:#00e5ff"></b>
          </div>
          <button type="button" class="btnAlt" id="changeNickBtn">Cambia</button>
        </div>

        <input id="email" placeholder="Email" autocomplete="username">
        <input id="password" type="password" placeholder="Password" autocomplete="current-password">
        <div style="display:flex;gap:8px;margin-top:8px">
          <button class="btnMain" onclick="login()">Login</button>
          <button class="btnAlt" onclick="signup()">Registrati</button>
        </div>
      </div>

      <div id="userInfo" style="display:none">
        Loggato come <b id="userEmail"></b>
        <button class="btnAlt" onclick="logout()" style="margin-left:8px">Logout</button>
        <button id="radarBtn" onclick="toggleRadar()">üü¢ Radar ON</button>

        <!-- üîî + üîÑ sulla stessa riga -->
        <div style="display:flex;gap:8px;margin-top:6px">
          <button id="notifBtn" onclick="toggleNotifications()">üîî Notifiche OFF</button>
          <button id="refreshBtn" onclick="refreshApp()">üîÑ Refresh</button>
        </div>
      </div>
    </div>

    <div id="chatBody">
      <div id="chatList"></div>

      <div id="chat">
        <div id="chatHeader">Seleziona una chat</div>
        <div id="messages"></div>

        <div id="composer">
          <div id="composerRow">
            <input id="msgInput" placeholder="Scrivi un messaggio" disabled>
            <button id="sendBtn" onclick="sendMsg()" disabled>Invia</button>
          </div>
        </div>
      </div>
    </div>

  </div>
</div>

<!-- sopra la mappa -->
<button id="rvToggle" type="button">üìç Rendez-vous</button>

<div id="rvPanel">
  <div id="rvHeader">
    Rendez-vous camperisti
    <button id="rvClose" type="button">Chiudi</button>
  </div>

  <div id="rvForm">
    <div id="rvFormRow">
      <div>
        <input id="rvAddress" placeholder="Indirizzo esatto (clicca su mappa)" readonly>
        <div id="rvHint">Premi ‚ÄúSeleziona da mappa‚Äù, poi clicca un punto sulla mappa.</div>
      </div>
      <div>
        <input id="rvContact" placeholder="Contatto (mail o telefono)">
        <button id="rvPickBtn" type="button" style="margin-top:8px;width:100%">üìå Seleziona da mappa</button>
      </div>
    </div>

    <textarea id="rvText" maxlength="200" placeholder="Messaggio (max 200 caratteri)"></textarea>

    <div id="rvDateRow">
      <input id="rvStart" type="datetime-local">
      <input id="rvEnd" type="datetime-local">
    </div>
    <div style="font-size:12px;color:#aaa;margin-top:-6px">
      Data rendez-vous: <b>DAL</b> e <b>AL</b> (obbligatorio). Dopo 24 ore dalla fine viene cancellato.
    </div>

    <div id="rvActions">
      <button class="btnMain" id="rvPublishBtn" type="button">Pubblica</button>
      <button id="rvCancelEditBtn" type="button">Annulla</button>
    </div>
  </div>

  <div id="rvList"></div>
</div>

<script>
/* ===== SUPABASE ===== */
const sb = supabase.createClient(
  "https://knxmhhdzjnchafkigjzo.supabase.co",
  "sb_publishable_9xJNnzDuhwXWx76SHb2ILQ_PWsLDhvD"
);

let user=null, profiles={}, chats={}, activePeer=null;
let map=null, myMarker=null, geoWatch=null;
let otherMarkers=[]; // ‚úÖ per rifare i marker con refresh

const RADAR_KEY="cb_radar_started";
const RADAR_DURATION=86400000;
let radarOn=false;

let pickMode=false;
let pickedLatLng=null;
let editingRVId=null;

const NICK_KEY="cb_nickname";

/* üîî NOTIFICHE (solo quando browser/app √® aperta) */
const NOTIF_KEY="cb_notifications_enabled";
let notifOn=false;
let unreadCount=0;

/* ‚úÖ LISTA CHAT ‚ÄúPULITA‚Äù: SOLO CONTATTI CLICCATI O CHE TI HANNO SCRITTO */
const PEERS_KEY="cb_chat_peers";
let peersSet = new Set();

/* ===== UI helpers ===== */
const $ = (id)=>document.getElementById(id);
function safeName(uid){ return profiles[uid]?.display_name || profiles[uid]?.username || uid; }

function toLocalInputValue(iso){
  if(!iso) return "";
  const d = new Date(iso);
  const pad = n => String(n).padStart(2,"0");
  return d.getFullYear()+"-"+pad(d.getMonth()+1)+"-"+pad(d.getDate())+"T"+pad(d.getHours())+":"+pad(d.getMinutes());
}

async function reverseGeocode(lat,lng){
  try{
    const url = `https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${encodeURIComponent(lat)}&lon=${encodeURIComponent(lng)}&zoom=18&addressdetails=1`;
    const res = await fetch(url, { headers: { "Accept":"application/json" } });
    const js = await res.json();
    return js?.display_name || `${lat.toFixed(6)}, ${lng.toFixed(6)}`;
  }catch(e){
    return `${lat.toFixed(6)}, ${lng.toFixed(6)}`;
  }
}

function getNick(){
  return (localStorage.getItem(NICK_KEY) || "").trim();
}
function setNick(n){
  localStorage.setItem(NICK_KEY, (n||"").trim());
}

/* ‚úÖ peers helpers */
function loadPeers(){
  try{
    const arr = JSON.parse(localStorage.getItem(PEERS_KEY) || "[]");
    peersSet = new Set((arr||[]).filter(Boolean));
  }catch(e){
    peersSet = new Set();
  }
}
function savePeers(){
  try{
    localStorage.setItem(PEERS_KEY, JSON.stringify(Array.from(peersSet)));
  }catch(e){}
}
function addPeer(pid){
  if(!pid) return;
  if(!peersSet.has(pid)){
    peersSet.add(pid);
    savePeers();
  }
  chats[pid]=chats[pid]||[];
}
function removePeer(pid){
  if(!pid) return;
  if(peersSet.has(pid)){
    peersSet.delete(pid);
    savePeers();
  }
  delete chats[pid];
  if(activePeer===pid) activePeer=null;
}

/* ===== Nick UI (prima volta s√¨, poi no) ===== */
function syncNickUI(){
  const nick = getNick();
  const nickRow = $("nickRow");
  const nickDispRow = $("nickDisplayRow");

  if(!nick){
    nickRow.style.display = "";
    nickDispRow.style.display = "none";
    $("nickname").value = "";
  }else{
    nickRow.style.display = "none";
    nickDispRow.style.display = "flex";
    $("nickDisplay").innerText = nick;
    $("nickname").value = nick;
  }
}

$("changeNickBtn").onclick = ()=>{
  $("nickRow").style.display = "";
  $("nickDisplayRow").style.display = "none";
  $("nickname").focus();
};

/* üîî Notifiche helpers */
function restoreNotifState(){
  notifOn = localStorage.getItem(NOTIF_KEY) === "1";
  updateNotifBtn();
}

function updateNotifBtn(){
  const b = $("notifBtn");
  if(!b) return;
  b.innerText = notifOn ? "üîî Notifiche ON" : "üîî Notifiche OFF";
}

async function toggleNotifications(){
  if(!("Notification" in window)){
    alert("Questo browser non supporta le notifiche.");
    return;
  }
  if(!notifOn){
    const perm = await Notification.requestPermission();
    if(perm !== "granted"){
      notifOn=false;
      localStorage.setItem(NOTIF_KEY,"0");
      updateNotifBtn();
      alert("Permesso notifiche negato. Se vuoi, riattivalo dalle impostazioni del browser.");
      return;
    }
    notifOn=true;
    localStorage.setItem(NOTIF_KEY,"1");
    updateNotifBtn();
    try{ new Notification("CamperBuddy", { body: "Notifiche attivate ‚úÖ" }); }catch(e){}
  }else{
    notifOn=false;
    localStorage.setItem(NOTIF_KEY,"0");
    updateNotifBtn();
  }
}

/* Notifica solo se: notif attive + pagina non visibile O non sei in quella chat */
function maybeNotifyMessage(m){
  try{
    if(!notifOn) return;
    if(!("Notification" in window)) return;
    if(Notification.permission !== "granted") return;

    const senderName = safeName(m.sender);
    const shouldNotify = document.hidden || activePeer !== m.sender;

    if(!shouldNotify) return;

    unreadCount++;
    document.title = unreadCount > 0 ? `(${unreadCount}) CamperBuddy` : "CamperBuddy";

    if(navigator.vibrate) navigator.vibrate([120,60,120]);

    new Notification("Nuovo messaggio", {
      body: `${senderName}: ${m.body || ""}`.slice(0,160)
    });
  }catch(e){}
}

/* azzera badge quando torni visibile */
document.addEventListener("visibilitychange", ()=>{
  if(!document.hidden){
    unreadCount=0;
    document.title="CamperBuddy";
  }
});

/* ===== AUTH ===== */
async function login(){
  const email = ($("email").value || "").trim();
  const password = $("password").value;

  let nickname = ($("nickname").value || "").trim();
  if(!nickname) nickname = getNick();

  if(!nickname) return alert("Inserisci il Nick name (solo la prima volta).");
  if(!email || !password) return alert("Inserisci email e password.");

  setNick(nickname);

  const { error } = await sb.auth.signInWithPassword({email,password});
  if(error) alert(error.message);
  else location.reload();
}

async function signup(){
  const email = ($("email").value || "").trim();
  const password = $("password").value;

  let nickname = ($("nickname").value || "").trim();
  if(!nickname) nickname = getNick();

  if(!nickname) return alert("Inserisci il Nick name.");
  if(!email || !password) return alert("Inserisci email e password.");

  setNick(nickname);

  const { error } = await sb.auth.signUp({email,password});
  if(error) alert(error.message);
  else alert("Registrato. Ora fai login.");
}

async function logout(){
  await sb.auth.signOut();
  location.reload();
}

/* ===== START ===== */
sb.auth.getSession().then(async({data})=>{
  syncNickUI();
  loadPeers();

  if(data.session){
    user = data.session.user;
    $("authForm").style.display="none";
    $("userInfo").style.display="block";
    $("userEmail").innerText = user.email;

    await ensureMyNickname();
    await start();
  }else{
    initMapEmpty();
    hookRVUI();
  }
});

async function ensureMyNickname(){
  if(!user) return;

  let nick = getNick();

  if(!nick){
    const { data, error } = await sb.from("profiles").select("display_name").eq("user_id", user.id).maybeSingle();
    if(!error && data?.display_name){
      setNick(data.display_name);
      syncNickUI();
      return;
    }

    const suggested = (user.email || "").split("@")[0] || "Camperista";
    const chosen = (prompt("Scegli un Nick name (solo la prima volta):", suggested) || "").trim() || suggested;
    setNick(chosen);
    nick = chosen;
    syncNickUI();
  }

  const { error: upErr } = await sb.from("profiles").upsert(
    { user_id: user.id, display_name: nick },
    { onConflict: "user_id" }
  );

  if(upErr) console.warn("profiles upsert:", upErr.message);
}

async function start(){
  await loadProfiles();
  initMap();
  restoreRadarState();
  restoreNotifState();
  startPolling();
  hookRVUI();
  await loadRV();

  renderChatList();
  renderMessages();
}

/* ===== PROFILES ===== */
async function loadProfiles(){
  const { data, error } = await sb.from("profiles").select("*");
  if(error){ console.warn(error.message); return; }
  profiles={};
  (data||[]).forEach(p=>profiles[p.user_id]=p);

  if(user && !getNick() && profiles[user.id]?.display_name){
    setNick(profiles[user.id].display_name);
    syncNickUI();
  }
}

/* ===== MAP ===== */
function initMapEmpty(){
  map=L.map("map").setView([45.4,11],6);
  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{maxZoom:19}).addTo(map);
  setTimeout(()=>map.invalidateSize(true),400);
}

function clearOtherMarkers(){
  try{
    otherMarkers.forEach(m=>{ try{ map.removeLayer(m); }catch(e){} });
  }catch(e){}
  otherMarkers=[];
}

function rebuildOtherMarkers(){
  if(!map || !user) return;
  clearOtherMarkers();

  Object.values(profiles).forEach(u=>{
    if(!u?.lat || !u?.lng) return;
    if(u.user_id===user.id) return;

    const m=L.marker([u.lat,u.lng]).addTo(map).bindPopup(u.display_name||u.username||u.user_id);

    // ‚úÖ CLICK MARKER = aggiungi contatto e apri chat
    m.on("click",()=>{
      addPeer(u.user_id);
      openChat(u.user_id);
    });

    otherMarkers.push(m);
  });
}

function initMap(){
  map=L.map("map").setView([45.4,11],6);
  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{maxZoom:19}).addTo(map);
  setTimeout(()=>map.invalidateSize(true),400);

  rebuildOtherMarkers();

  map.on("click", async (e)=>{
    if(!pickMode) return;
    pickedLatLng = e.latlng;

    const addr = await reverseGeocode(pickedLatLng.lat, pickedLatLng.lng);
    $("rvAddress").value = addr;

    pickMode=false;
    $("rvPickBtn").textContent="üìå Seleziona da mappa";
  });
}

/* ===== RADAR ===== */
function restoreRadarState(){
  const t=localStorage.getItem(RADAR_KEY);
  if(t && Date.now()-Number(t) < RADAR_DURATION){
    radarOn=true;
    $("radarBtn").innerText="üü¢ Radar ON";
    startGeo();
  }else{
    radarOn=false;
    $("radarBtn").innerText="üî¥ Radar OFF";
  }
}

/* ‚úÖ MODIFICA: quando Radar OFF -> lat/lng NULL su Supabase (sparisci agli altri) */
async function toggleRadar(){
  if(!user) return alert("Devi essere loggato.");

  if(radarOn){
    // OFF
    radarOn=false;
    localStorage.removeItem(RADAR_KEY);

    if(myMarker) map.removeLayer(myMarker);
    myMarker=null;

    if(geoWatch) navigator.geolocation.clearWatch(geoWatch);
    geoWatch=null;

    // ‚úÖ sparisci anche nel DB
    try{
      const { error } = await sb.from("profiles").update({ lat: null, lng: null }).eq("user_id", user.id);
      if(error) console.warn("profiles clear lat/lng:", error.message);
    }catch(e){
      console.warn("profiles clear lat/lng error:", e);
    }
  }else{
    // ON
    radarOn=true;
    localStorage.setItem(RADAR_KEY, String(Date.now()));
    startGeo();
  }

  $("radarBtn").innerText = radarOn ? "üü¢ Radar ON" : "üî¥ Radar OFF";
}

function startGeo(){
  if(!navigator.geolocation) return;
  geoWatch = navigator.geolocation.watchPosition(async p=>{
    const {latitude:lat,longitude:lng}=p.coords;
    if(!myMarker){
      myMarker=L.circleMarker([lat,lng],{radius:8,color:"#ff3333",fillColor:"#ff0000",fillOpacity:1}).addTo(map);
    }else{
      myMarker.setLatLng([lat,lng]);
    }
    await sb.from("profiles").update({lat,lng}).eq("user_id",user.id);
  });
}

/* ===== CHAT ===== */
function openChat(pid){
  activePeer=pid;
  addPeer(pid);

  renderChatList();
  renderMessages();

  unreadCount=0;
  document.title="CamperBuddy";
}

/* ‚úÖ FIX: il cestino cancella anche i messaggi su Supabase */
async function deleteChat(pid){
  if(!confirm("Cancellare chat?")) return;

  try{
    const del1 = await sb.from("messages").delete().match({ sender: user.id, receiver: pid });
    const del2 = await sb.from("messages").delete().match({ sender: pid, receiver: user.id });

    if(del1?.error) console.warn("delete out:", del1.error.message);
    if(del2?.error) console.warn("delete in:", del2.error.message);
  }catch(e){
    console.warn("deleteChat error:", e);
  }

  removePeer(pid);

  renderChatList();
  renderMessages();
}

function renderChatList(){
  $("chatList").innerHTML="";

  const peers = Array.from(peersSet);

  peers.sort((a,b)=>{
    const la = chats[a]?.[chats[a].length-1]?.created_at || "";
    const lb = chats[b]?.[chats[b].length-1]?.created_at || "";
    if(la===lb) return safeName(a).localeCompare(safeName(b));
    return la<lb ? 1 : -1;
  });

  peers.forEach(pid=>{
    chats[pid]=chats[pid]||[];
    const c=chats[pid];

    const el=document.createElement("div");
    el.className="chatItem"+(pid===activePeer?" active":"");
    el.onclick=()=>openChat(pid);
    el.innerHTML=`<div class="chatText"><div class="chatName">${safeName(pid)}</div><div class="chatLast">${c[c.length-1]?.body||""}</div></div>`;

    const d=document.createElement("div");
    d.className="chatDel"; d.innerText="üóë";
    d.onclick=async (e)=>{ e.stopPropagation(); await deleteChat(pid); };

    el.appendChild(d);
    $("chatList").appendChild(el);
  });

  if(!peers.length){
    const e=document.createElement("div");
    e.style.color="#aaa";
    e.style.padding="10px";
    e.textContent="Nessuna chat ancora. Clicca un camper sulla mappa per iniziare üòé";
    $("chatList").appendChild(e);
  }
}

function renderMessages(){
  $("messages").innerHTML="";
  if(!activePeer){
    $("chatHeader").innerText="Seleziona una chat";
    $("msgInput").disabled=true;
    $("sendBtn").disabled=true;
    return;
  }
  $("chatHeader").innerText=safeName(activePeer);
  $("msgInput").disabled=false;
  $("sendBtn").disabled=false;

  (chats[activePeer]||[]).forEach(m=>{
    const d=document.createElement("div");
    d.className="msg "+(m.sender===user.id?"me":"them");
    d.innerText=m.body;
    $("messages").appendChild(d);
  });
  $("messages").scrollTop=$("messages").scrollHeight;
}

async function sendMsg(){
  const t=$("msgInput").value.trim();
  if(!t || !activePeer) return;

  addPeer(activePeer);

  const m={sender:user.id,receiver:activePeer,body:t,created_at:new Date().toISOString()};
  chats[activePeer].push(m);
  renderMessages(); renderChatList();
  $("msgInput").value="";
  await sb.from("messages").insert(m);
}

function startPolling(){
  setInterval(async ()=>{
    if(!user) return;
    const {data} = await sb.from("messages").select("*").eq("receiver",user.id);
    if(!data) return;
    data.forEach(m=>{
      addPeer(m.sender);

      chats[m.sender]=chats[m.sender]||[];
      if(chats[m.sender].some(x=>x.created_at===m.created_at)) return;
      chats[m.sender].push(m);

      maybeNotifyMessage(m);

      renderChatList();
      if(activePeer===m.sender) renderMessages();
    });
  },3000);
}

/* ‚úÖ REFRESH ‚ÄúSOFT‚Äù */
async function refreshApp(){
  try{
    const btn = $("refreshBtn");
    if(btn){ btn.disabled=true; btn.textContent="‚è≥"; }

    await loadProfiles();
    if(map && user){
      rebuildOtherMarkers();
    }

    if(user){
      const { data, error } = await sb
        .from("messages")
        .select("*")
        .or(`receiver.eq.${user.id},sender.eq.${user.id}`)
        .order("created_at",{ascending:true});

      if(!error && data){
        const newChats = {};
        data.forEach(m=>{
          const other = (m.sender===user.id) ? m.receiver : m.sender;

          if(m.receiver===user.id) addPeer(other);

          if(!peersSet.has(other)) return;

          newChats[other] = newChats[other] || [];
          if(newChats[other].some(x=>x.created_at===m.created_at)) return;
          newChats[other].push(m);
        });
        chats = newChats;
      }
    }

    await loadRV();

    renderChatList();
    renderMessages();
  }catch(e){
    console.warn("refreshApp:", e);
  }finally{
    const btn = $("refreshBtn");
    if(btn){
      btn.disabled=false;
      btn.textContent="üîÑ Refresh";
    }
  }
}

/* ===== RENDEZ-VOUS UI + DB ===== */
function hookRVUI(){
  $("rvToggle").onclick=()=> $("rvPanel").classList.toggle("open");
  $("rvClose").onclick=()=> $("rvPanel").classList.remove("open");

  $("rvPickBtn").onclick=()=>{
    if(!user) return alert("Devi essere loggato.");
    pickMode = !pickMode;
    $("rvPickBtn").textContent = pickMode ? "üü£ Clicca sulla mappa..." : "üìå Seleziona da mappa";
  };

  $("rvPublishBtn").onclick=publishOrUpdateRV;
  $("rvCancelEditBtn").onclick=()=>{
    editingRVId=null;
    $("rvPublishBtn").textContent="Pubblica";
    $("rvCancelEditBtn").style.display="none";
    $("rvAddress").value="";
    $("rvContact").value="";
    $("rvText").value="";
    $("rvStart").value="";
    $("rvEnd").value="";
    pickedLatLng=null;
  };
}

async function publishOrUpdateRV(){
  if(!user) return alert("Devi essere loggato.");

  const address = $("rvAddress").value.trim();
  const contact = $("rvContact").value.trim();
  const text = $("rvText").value.trim();
  const startLocal = ($("rvStart").value||"").trim();
  const endLocal = ($("rvEnd").value||"").trim();

  if(!address || !contact || !text || !startLocal || !endLocal) return alert("Compila tutto (indirizzo, contatto, messaggio, DAL e AL).");
  if(text.length>200) return alert("Max 200 caratteri.");
  const startIso = new Date(startLocal).toISOString();
  const endIso = new Date(endLocal).toISOString();
  if(new Date(endIso) <= new Date(startIso)) return alert("La data AL deve essere dopo la data DAL.");

  const myNick = profiles?.[user.id]?.display_name || getNick() || user.email;

  const payload = {
    user_id:user.id,
    username: myNick,
    address, contact, text,
    start_at:startIso,
    end_at:endIso,
    lat: pickedLatLng ? pickedLatLng.lat : null,
    lng: pickedLatLng ? pickedLatLng.lng : null
  };

  if(editingRVId){
    const {error} = await sb.from("rendezvous").update(payload).eq("id",editingRVId).eq("user_id",user.id);
    if(error) return alert(error.message);
  }else{
    const {error} = await sb.from("rendezvous").insert(payload);
    if(error) return alert(error.message);
  }

  editingRVId=null;
  $("rvPublishBtn").textContent="Pubblica";
  $("rvCancelEditBtn").style.display="none";
  $("rvAddress").value="";
  $("rvContact").value="";
  $("rvText").value="";
  $("rvStart").value="";
  $("rvEnd").value="";
  pickedLatLng=null;

  loadRV();
}

async function loadRV(){
  $("rvList").innerHTML="";
  const {data, error} = await sb.from("rendezvous").select("*").order("created_at",{ascending:false});
  if(error) { console.warn(error.message); return; }

  (data||[]).forEach(rv=>{
    const d=document.createElement("div");
    d.className="rvItem";

    const created = rv.created_at ? new Date(rv.created_at).toLocaleString("it-IT") : "";
    const startW  = rv.start_at ? new Date(rv.start_at).toLocaleString("it-IT") : "‚Äî";
    const endW    = rv.end_at ? new Date(rv.end_at).toLocaleString("it-IT") : "‚Äî";

    const top=document.createElement("div");
    top.className="rvTop";
    top.innerHTML=`
      <div>
        <div class="rvUser">${rv.username||"‚Äî"}</div>
        <div class="rvMeta">${created}</div>
        <div class="rvMeta"><b>Dal:</b> ${startW} &nbsp; <b>Al:</b> ${endW}</div>
        <div class="rvMeta">${rv.address||""}</div>
        <div class="rvMeta"><b>Contatto:</b> ${rv.contact||""}</div>
      </div>
    `;

    const btns=document.createElement("div");
    btns.className="rvBtns";

    if(user && rv.user_id===user.id){
      const bE=document.createElement("button");
      bE.className="rvBtnEdit"; bE.textContent="Modifica";
      bE.onclick=()=>editRV(rv);

      const bD=document.createElement("button");
      bD.className="rvBtnDel"; bD.textContent="Cancella";
      bD.onclick=()=>deleteRV(rv.id);

      btns.appendChild(bE);
      btns.appendChild(bD);
    }

    top.appendChild(btns);

    const txt=document.createElement("div");
    txt.className="rvText";
    txt.textContent=rv.text||"";

    d.appendChild(top);
    d.appendChild(txt);
    $("rvList").appendChild(d);
  });

  if(!(data||[]).length){
    const e=document.createElement("div");
    e.style.color="#aaa";
    e.style.padding="8px";
    e.textContent="Nessun rendez-vous pubblicato. Sii il primo üòé";
    $("rvList").appendChild(e);
  }
}

function editRV(rv){
  editingRVId=rv.id;
  $("rvPublishBtn").textContent="Salva modifiche";
  $("rvCancelEditBtn").style.display="inline-block";

  $("rvAddress").value=rv.address||"";
  $("rvContact").value=rv.contact||"";
  $("rvText").value=rv.text||"";
  $("rvStart").value=toLocalInputValue(rv.start_at);
  $("rvEnd").value=toLocalInputValue(rv.end_at);

  if(rv.lat && rv.lng) pickedLatLng={lat:rv.lat,lng:rv.lng}; else pickedLatLng=null;

  $("rvPanel").classList.add("open");
}

async function deleteRV(id){
  if(!confirm("Cancellare l'annuncio?")) return;
  const {error} = await sb.from("rendezvous").delete().eq("id",id).eq("user_id",user.id);
  if(error) return alert(error.message);
  loadRV();
}
</script>

</body>
</html>
